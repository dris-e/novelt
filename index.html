<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div class="navbar">
        <div id="navbar-left">
            <button id="sidebar-toggle">☰</button>
            <h1 id="timer" style="font-weight: 400"></h1>
        </div>
        <h1 id="title-text">apushy</h1>
        <input type="text" id="chatboard-search" placeholder="chatboard name search">
        <input type="password" id="chatboard-password" placeholder="chatboard password" style="display: none">
        <button id="create-chatboard-toggle">create chatboard</button>
    </div>
    <div class="sidebar">
        <label for="sort-chatboards">sort</label>
        <select id="sort-chatboards">
            <option value="popularity">popularity (default)</option>
            <option value="latest">latest</option>
        </select>
        <ul id="chatboards"></ul>
    </div>

    <div class="chatboard-content">
        <div class="my-chatboard-container" style="height: 0px; opacity: 0; margin: -2rem">
            <h2>create chatboard</h2>
            <input type="text" id="chatboard-name" placeholder="chatboard name">
            <input type="text" id="chatboard-descript" placeholder="chatboard description">
            <input type="checkbox" id="chatboard-username" name="chatboard-username">
            <label for="chatboard-username">anonymous</label>
            <input type="checkbox" id="chatboard-private" name="chatboard-private">
            <label for="chatboard-private">private</label>
            <input type="password" id="chatboard-pass" placeholder="chatboard password" style="display: none">
            <button id="create-chatboard">create</button>
        </div>
    
        <div class="my-chatboard-details">
            <div id="chatboard-content-details" style="display: none">
                <h1 id="chatboard-title">title</h1>
                <h3 id="chatboard-description">description</h3>
                <p id="chatboard-details">details</p>
            </div>
        </div>

        <div class="my-send">
            <h2>send mesasge</h2>
            <textarea type="text" id="text-input" placeholder="message"></textarea>
            <input id="username" placeholder="name">
            <input type="file" id="file-upload">
            <button id="send-button">send</button>
        </div>
        
        <div class="my-message-container" style="display: none;">
            <label for="sort-messages">sort</label>
            <select id="sort-messages">
                <option value="popularity">popularity (default)</option>
                <option value="latest">latest</option>
            </select>
            <div class="chatboard-container">
                <ul id="messages"></ul>
            </div>
        </div>
    </div>
    <script>
        const socket = io();

        const timer = document.getElementById("timer");
        const chatboardTitle = document.getElementById("title-text");
        const chatboardDetails = document.getElementById("chatboard-content-details");
        const title = document.getElementById("chatboard-title");
        const description = document.getElementById("chatboard-description"); 
        const details = document.getElementById("chatboard-details");

        const chatboardName = document.getElementById("chatboard-name");
        const chatboardDescript = document.getElementById("chatboard-descript");
        const chatboardUser = document.getElementById("chatboard-username");
        const chatboardPriv = document.getElementById("chatboard-private");
        const chatboardPass = document.getElementById("chatboard-pass");
        const create = document.getElementById("create-chatboard");
        const chatboardSearch = document.getElementById("chatboard-search");
        const chatboardPassword = document.getElementById("chatboard-password");
        const chatboardToggle = document.getElementById("create-chatboard-toggle");

        const input = document.getElementById("text-input");
        const username = document.getElementById("username");
        const send = document.getElementById("send-button");

        const messages = document.getElementById("messages");
        const sortMessages = document.getElementById("sort-messages");
        const chatboards = document.getElementById("chatboards");
        const sortChatboards = document.getElementById("sort-chatboards");
        const messageContainer = document.querySelector(".my-message-container");

        const chatboardContainer = document.querySelector(".my-chatboard-container");

        let fileUpload = document.getElementById("file-upload");
        let currentListener = null;
        let currentIndex = 0;
        let boardName = "";
        let loadingMore = false;
        let chatboardCount = 0;
        let skipChatboards = 0;

        window.onload = (event) => {
            getChatboards(sortChatboards.value);
        };

        sortChatboards.addEventListener("change", () => {
            getChatboards(sortChatboards.value);
        });

        create.addEventListener("click", () => {
            if (chatboardName.value.trim() && chatboardDescript.value.trim()) {
                console.log("create");
                fetch("/createChatboard", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ name: chatboardName.value, description: chatboardDescript.value, username: chatboardUser.checked, private: chatboardPriv.checked, pass: chatboardPass.value })
                })
                .then(response => response.json())
                .then(data => {
                    searchChatboards(data.name);
                })
                chatboardName.value = "";
                chatboardDescript.value = "";
                chatboardUser.checked = false;
                chatboardPriv.checked = false;
                chatboardPass.value = "";
            }
        });

        chatboardSearch.addEventListener("change", () => {
            if (chatboardSearch.value.trim()) {
                searchChatboards(chatboardSearch.value);
            }
        });

        chatboardPassword.addEventListener("change", () => {
            if (chatboardSearch.value.trim()) {
                searchChatboards(chatboardSearch.value);
            }
        });

        send.addEventListener("click", () => {
            if (boardName && input.value.trim()) {
                console.log("send");
                let name = username.value != "" ? username.value : "Anonymous";

                let formData = new FormData();
                formData.append("message", input.value);
                formData.append("username", name);
                formData.append("image", fileUpload.files[0]);

                fetch(`/postMessage/${boardName}`, {
                    method: "POST",
                    body: formData
                    // headers: {
                    //     "Content-Type": "application/json"
                    // },
                    // body: JSON.stringify({ message: input.value, image: fileUpload.files[0], username: name })
                })
                .then(response => response.json())
                .then(msg => {
                    // addMessageToList(msg);
                    // fetch(`/messages.${boardName}`)
                    // .then(response => response.json())
                    // .then(messagesData => {
                    //     messages.innerHTML = "";
                    //     for (let msg of messagesData) {
                    //         addMessageToList(msg);
                    //     }
                    // });
                    // loadChatboards(msg, sortMessages.value);
                });
                input.value = "";
            }
        });

        socket.on("reloadMessages", (data) => {
            let messageList = document.getElementById("messages");
            while (messageList.firstChild) {
                messageList.firstChild.remove();
            }
            messages.forEach(msg => {
                addMessageToList(msg);
            });
        });

        socket.on("updateTimer", (data) => {
            timer.textContent = `${data.hours}:${data.mins}:${data.secs}`;
        });

        socket.on("reloadMessages", (newMsgs) => {
            messages.innerHTML = "";
            newMsgs.forEach(addMessageToList);
        });

        socket.on("newMessage", (data) => {
            console.log(data.chatboardName, boardName);
            if (data.chatboardName === boardName) {
                console.log("possibly");
                loadChatboards(data.chatboard, sortMessages.value); //most desginfitely not security risk in any way :thumbsup:
            }
        });

        socket.on("newReply", (data) => {
            let chatItem = document.querySelector(`li[data-id="${data.chat._id}"]`);
            if (chatItem) {
                chatItem.remove();
            }
            loadChatboards(data.board, sortMessages.value);
        });

        socket.on("newReaction", (data) => {
            const msg = document.querySelector(`[data-id="${data.chatId}"]`);
            if (msg) {
                const reaction = msg.querySelector(".reactions");
                const reactionCounts = data.newMessage.reactions.reduce((counts, reaction) => {
                    counts[reaction.emoji] = (counts[reaction.emoji] || 0) + 1;
                    return counts;
                }, {});
                reaction.innerHTML = `Reactions: ${Object.entries(reactionCounts).map(([emoji, count]) => `${emoji} ${count}x`).join(" ")}`;
                // loadChatboards({ name: boardName }, sortMessages.value);
            }
        });

        function searchChatboards(chatboardSearch) {
            console.log("searcj");
            fetch(`/searchChatboard/${chatboardSearch}`)
            .then(response => response.json())
            .then(data => {
                let newData = data;
                if (data.private) {
                    chatboardPassword.style.display = "block";
                    let password = chatboardPassword.value;
                    fetch("verifyPassword", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ name: data.name, pass: password })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message === "good") {
                            console.log("good");
                            loadChatboards(newData);
                        } else {
                            console.log("wrong");
                            return;
                        }
                    });
                    chatboardSearch.value = "";
                    chatboardPassword.value = "";
                } else {
                    chatboardPassword.style.display = "none";
                    loadChatboards(data);
                }
                // history.pushState(null, null, `/chatboard/${data.name}`); KEYWORD
                // renderChatboard(data);
            });
            // window.scrollTo(0, document.body.scrollTop);
        }

        function getChatboards(sort = "popularity") {
            fetch(`/getChatboards/${sort}`)
            .then(response => response.json())
            .then(data => {
                while(chatboards.firstChild) {
                    chatboards.removeChild(chatboards.firstChild);
                }

                for(let chatboard of data){
                    addChatboardToList(chatboard);
                }
            });
        }

        function loadChatboards(data, sort = "popularity") {
            boardName = data.name; // hmm
            // const currentUrl = window.location.pathname; KEYWORD
            // if (currentUrl.includes("/chatboard/")) {
            //     const newBoardName = currentUrl.replace("/chatboard/", "");
            //     if (newBoardName === data.name) {
            //         renderChatboard(data);
            //     }
            // }
            if (data.name) {
                chatboardDetails.style.display = "block";
            }
            messageContainer.style.display = "block";
            title.innerHTML = `<h1 style="color: ${data.creator ? data.creator : "fff"}">${boardName} <span style="color: #fff">${data.private ? "| Private" : ""}</span></h1>`;
            description.innerHTML = data.description;
            details.innerHTML = `Creator: ${data.creator ? data.creator : "me"} | Lifetime messages: ${data.messages.length ? data.messages.length : "a lot probably"} | Created: ${new Date(data.timestamp).toLocaleString()}`;
            messages.innerHTML = "";
            currentIndex = 0;
            // chatboards.innerHTML = "";
            fetch(`/messages/${boardName}/${sort}`)
            .then(response => response.json())
            .then(messagesData => {
                while (messages.firstChild) {
                    messages.removeChild(messages.firstChild);
                }
                messagesData.forEach((msg, index) => {
                    addMessageToList(msg, index === currentIndex);
                    console.log(index);
                });
                // for (let msg in messagesData) {
                //     addMessageToList(msg)
                // }
            });
            if (currentListener) {
                sortMessages.removeEventListener("change", currentListener);
            }
            currentListener = () => {
                loadChatboards(data, sortMessages.value);
            }
            sortMessages.addEventListener("change", currentListener);
        }

        function addMessageToList(msg, isActive) {
            if (msg.message && msg.message.trim()) {
                console.log("add");
                let isClicked = false; //now works !!
                let newFile = "";
                let emojiList;
                let item = document.createElement("li");
                item.setAttribute("data-id", msg._id);

                if (msg.image && msg.imageMime) {
                    const mimeType = msg.imageMime;
                    if (mimeType && mimeType.startsWith("image/")) {
                        newFile = `<img src="${msg.image}" alt="${msg.message}"/>`;
                    } else if (mimeType && mimeType === "application/pdf") {
                        // newFile = `<object data="${msg.image}" type="application/pdf"></object>
                        //         <a href="${msg.image}">download</a>`;
                    } else {
                        newFile = `<p>bro thinks he can upload anything BUT an image or pdf 🤓🤓🤓🤓<p>`;
                    }
                }
                
                const reactionCounts = msg.reactions.reduce((counts, reaction) => {
                    counts[reaction.emoji] = (counts[reaction.emoji] || 0) + 1;
                    return counts;
                }, {});
                item.innerHTML = `<div class="my-message">
                                <div class="cube-container">
                                    <div class="cube" style="width: 20px; height: 20px; background-color: ${msg.color}"></div><p class="color"></p><h4>${msg.username} - <span style="font-weight: normal; font-style: italic;">${new Date(msg.timestamp).toLocaleString()}:</span></h4>
                                </div>
                                <h3><span style="font-weight: bold">${msg.message}</span> | ${msg.views} ${msg.views === 1 ? "view" : "views"}</h3>
                                ${newFile}
                                <p class="reactions">Reactions: ${Object.entries(reactionCounts).map(([emoji, count]) => `${emoji} ${count}x`).join(" ") || "none"}</p>
                                <div class="reactions-container"></div>
                                <form class="reply-form">
                                    <input type="text" name="message" placeholder="reply">
                                    <input type="text" name="username" placeholder="name" value=${username.value || ""}>
                                    <button type="submit">send</button>
                                </form>
                                ${msg.replies ? `<button class="show-replies" style="display: none;">show replies (${msg.replies ? msg.replies.length : 0})</button>` : ""}
                                <ul class="replies" style="display: none">
                                    ${msg.replies ? msg.replies.map(reply => `<div class="my-reply"><li><div class="cube" style="width: 20px; height: 20px; background-color: ${reply.color}"></div>
                                                                            <p style="font-weight: bold">${reply.message} -&nbsp;</p>
                                                                            <span>${reply.username} | ${new Date(reply.timestamp).toLocaleString()}</span></li></div>`).join("") : ""}
                                </ul>
                                </div>`;

                if (isActive) {
                    item.classList.add("active");
                    item.scrollIntoView({ behavior: "smooth" });
                }
                const showReplies = item.querySelector(".show-replies");
                if (msg.replies) {
                    showReplies.style.display = "block";
                } else {
                    showReplies.style.display = "none";
                }
                item.addEventListener("dblclick", () => {
                    if (!isClicked) {
                        isClicked = true;
                        let reactionsContainer = item.querySelector(".reactions-container");
                        emojiList = document.createElement("ul");
                        let emojis = ["😍", "😂", "🧐", "😐", "🥺", "😭", "🤮", "🤓"];
                        for (let emoji of emojis) {
                            let emojiItem = document.createElement("li");
                            let button = document.createElement("button");
                            button.textContent = emoji;
                            button.addEventListener("click", (event) => {
                                event.stopPropagation();
                                fetch(`/addReaction/${msg._id}`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({ emoji: emoji })
                                })
                                .then(response => response.json())
                                .then(update => {
                                    console.log("updatetd");
                                });
                                isClicked = false;
                                emojiList.remove();
                            });
                            emojiItem.appendChild(button);
                            emojiList.appendChild(emojiItem);
                        }
                        reactionsContainer.appendChild(emojiList);
                    } else {
                        isClicked = false;
                        emojiList.remove();
                    }
                });
                const replyForm = item.querySelector(".reply-form");
                const repliesList = item.querySelector(".replies");
                const repliesButton = item.querySelector(".show-replies");
                replyForm.addEventListener("submit", (event) => {
                    event.preventDefault();
                    const newMsg  = replyForm.querySelector("input[name='message']").value;
                    const user = replyForm.querySelector("input[name='username']").value || username.value || "Anonymous";
                    if (newMsg.trim()) {
                        fetch(`/addReply/${msg._id}/${boardName}`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ user, newMsg })
                        })
                        .then(response => response.json())
                        .then(update => {
                            console.log("new reply :thumbup:");

                            repliesList.innerHTML = "";
                            update.replies.forEach(reply => {
                                let replyItem = document.createElement("li");
                                replyItem.innerHTML = `<div class="my-reply"><div class="cube" style="width: 20px; height: 20px; background-color: ${reply.color}"><p class="color"></p></div>
                                                        <p style="font-weight: bold">${reply.message} -&nbsp;</p>
                                                        <span>${reply.username} | ${new Date(reply.timestamp).toLocaleString}</span></div>`;
                                repliesList.appendChild(replyItem);
                            });
                        });

                        const cube = replyItem.querySelector(".cube");
                        const colorDisplay = item.querySelector(".color");

                        cube.addEventListener("mouseover", () => {
                            colorDisplay.innerHTML = `${reply.color}<br>`;
                        });
                        cube.addEventListener("mouseleave", () => {
                            colorDisplay.innerHTML = "";
                        });

                        newMsg.value = "";
                        replyForm.querySelector("input[name='username']").value = user;
                    }
                });
                const cube = item.querySelector(".cube");
                const colorDisplay = item.querySelector(".color");

                cube.addEventListener("mouseover", () => {
                    colorDisplay.innerHTML = `${msg.color}<br>`;
                });
                cube.addEventListener("mouseleave", () => {
                    colorDisplay.innerHTML = "";
                });

                repliesButton.addEventListener("click", () => {
                    event.stopPropagation();
                    if (repliesList.style.display === "none") {
                        repliesList.style.display = "block";
                        repliesButton.textContent = `hide replies (${msg.replies ? msg.replies.length : 0})`;
                    } else {
                        repliesList.style.display = "none"
                        repliesButton.textContent = `show replies (${msg.replies ? msg.replies.length : 0})`;
                    }
                });

                messages.appendChild(item);
            }
            // window.scrollTo(0, document.body.scrollTop);
        }

        function addChatboardToList(chatboard) {
            let item = document.createElement("li");
            item.innerHTML = `<div class="my-chatboard">
                            <div class="cube-container">
                                <div class="cube" style="width: 20px; height: 20px; background-color: ${chatboard.creator || "black"}"></div>
                                <h3>${chatboard.name} <span class="status"></span></h3>
                            </div>
                            <h4>${chatboard.description ? chatboard.description : ""}</h4>
                            <p>Lifetime views: ${chatboard.totalViews} | Created: ${chatboard.timestamp ? new Date(chatboard.timestamp).toLocaleString() : "sometime ago"}</p></div>`;
            if (chatboard.private) {
                item.querySelector(".status").innerHTML = "| private";
            }
            item.addEventListener("click", () => {
                // history.pushState(null, null, `/chatboard/${chatboard.name}`); KEYWORD
                // renderChatboard(chatboard);
                searchChatboards(chatboard.name);
            });
            chatboards.appendChild(item);
        }

        // function renderChatboard(data) { KEYWORD
        //     messages.innerHTML = "";
        //     // title.textContent = data.name;
        //     // description.textContent = data.description;

        //     for (let msg of data.messages) {
        //         addMessageToList(msg);
        //     }
        // }

        function navigateMessages(delta) {
            const messageItems = Array.from(messages.children);
            const nextIndex = currentIndex + delta;

            if (nextIndex >= 0 && nextIndex < messageItems.length) {
                if (currentIndex != -1) {
                    messageItems[currentIndex].classList.remove("active");
                }
                messageItems[nextIndex].classList.add("active");
                currentIndex = nextIndex;
                messageItems[nextIndex].scrollIntoView({ behavior: "smooth" });
            } else if (nextIndex === 0) {
                if (currentIndex != -1) {
                    messageItems[currentIndex].classList.remove("active");
                }
                messageItems[nextIndex].classList.add("active");
                currentIndex = nextIndex;
                messageItems[nextIndex].scrollIntoView({ behavior: "smooth" });
            }
        }

        function loadMoreChatboards() {
            const sort = sortChatboards.value;

            fetch(`/getChatboards/${sort}/${skipChatboards}`)
                .then((response) => response.json())
                .then((chatboardsData) => {
                    if (chatboardsData.length > 0) {
                        chatboardsData.forEach((chatboard) => {
                            addChatboardToList(chatboard);
                        });
                        chatboardCount += chatboardsData.length;
                        skipChatboards += chatboardsData.length;
                    }
                    loadingMore = false;
                });
        }

        // window.addEventListener("scroll", () => {
        //     const scrollingHeight = document.documentElement.scrollHeight - window.innerHeight;
        //     const scrollPosition = window.scrollY;

        //     if (!loadingMore && scrollPosition === scrollingHeight) {
        //         loadingMore = true;
        //         loadMoreChatboards();
        //     }
        // });

        const sidebar = document.querySelector(".sidebar");
        const main = document.querySelector(".chatboard-content");
        sidebar.style.width = "350px";
        main.style.marginLeft = "350px";

        document.getElementById("sidebar-toggle").addEventListener("click", () => {
        if (sidebar.style.width === "0px") {
            sidebar.style.width = "350px";
            sidebar.style.display = "block";
            main.style.marginLeft = "350px";
        } else {
            sidebar.style.width = "0px";
            sidebar.style.display = "none";
            main.style.marginLeft = "0px";
        }
        });

        chatboardPriv.addEventListener("click", () => {
            if (chatboardPass.style.display === "none") {
                chatboardPass.style.display = "block";
            } else {
                chatboardPass.style.display = "none";
            }
        });

        chatboardToggle.addEventListener("click", () => {
            if (chatboardContainer.style.opacity === "0") {
                chatboardContainer.style.opacity = "1";
                chatboardContainer.style.height = "auto";
                chatboardContainer.style.margin = "2rem auto";
            } else {
                chatboardContainer.style.opacity = "0";
                chatboardContainer.style.height = "0px";
                chatboardContainer.style.margin = "-2rem";
            }
        });

        let myTimeout = 1000;

        document.addEventListener("keydown", (even) => {
            if (event.key === "ArrowUp") {
                chatboardTitle.style.opacity = "0";
                myTimeout += 1000;
                event.preventDefault();
                navigateMessages(-1);
            } else if (event.key === "ArrowDown") {
                chatboardTitle.style.opacity = "0";
                myTimeout += 1000;
                event.preventDefault();
                navigateMessages(1);
            }
            setTimeout(() => {
                chatboardTitle.style.opacity = "1";
            }, myTimeout);
        });

        document.addEventListener("wheel", () => {
            event.preventDefault();
            chatboardTitle.style.opacity = "0";
            setTimeout(() => {
                chatboardTitle.style.opacity = "1";
            }, 1000);
            const delta = Math.sign(event.deltaY);
            navigateMessages(delta);
            console.log(delta);
        });
    </script>
</body>
</html>